# üßπüìä Cleanup & Metrics System Guide

This guide explains the **automatic cleanup** and **metrics tracking** system implemented to keep your Supabase database clean and provide valuable analytics.

## üéØ **What This System Does**

### **1. Database Cleanup**
- ‚úÖ **Deletes expired emails** from inactive inboxes
- ‚úÖ **Marks expired inboxes** as inactive
- ‚úÖ **Prevents database bloat** and saves storage costs
- ‚úÖ **Maintains performance** by removing old data

### **2. Metrics Tracking**
- ‚úÖ **Tracks email statistics** (sent, received, bounced)
- ‚úÖ **Monitors security events** (blocked, rate-limited)
- ‚úÖ **Records cleanup operations** (deleted emails, cleaned inboxes)
- ‚úÖ **Provides insights** and analytics

## üìä **Available Metrics**

### **Generation Statistics:**
- `total_emails_generated` - Total email addresses generated by your app
- `total_inboxes_created` - Total inboxes ever created (same as above)
- `current_active_inboxes` - Currently active inboxes
- `total_inboxes_ever` - All inboxes (active + inactive)

> **Note:** `total_emails_generated` and `total_inboxes_created` are the same value - each time a user clicks "Generate New Email" in your app, it creates one inbox and one email address. They're tracked separately for clarity.

### **Email Statistics:**
- `total_emails_received` - Emails successfully processed and stored
- `total_emails_sent` - Bounce notifications sent to senders
- `current_active_emails` - Emails currently in database

### **Expiry Statistics:**
- `total_inboxes_expired` - Total inboxes that have expired
- `total_emails_expired` - Total emails from expired inboxes
- `total_expired_inboxes_cleaned` - Expired inboxes processed by cleanup
- `total_expired_emails_deleted` - Old emails removed by cleanup

> **Expiry vs Cleanup Difference:**
> - **Expired** = naturally expired (time ran out) 
> - **Cleaned** = actually removed from database by cleanup process
> - Expired items stay in database until cleanup runs

### **Security Statistics:**
- `total_bounce_notifications` - Emails bounced (inbox not found)
- `total_suspicious_emails_blocked` - Malicious content blocked
- `total_rate_limited_emails` - Rate-limited requests

## üõ†Ô∏è **Setup Instructions**

### **Step 1: Create Metrics Table**
Run this SQL in your **Supabase SQL Editor**:

```sql
-- Copy and paste the entire content from:
-- database/06_create_metrics_table.sql
```

### **Step 2: Deploy Latest Code**
Your metrics tracking is already integrated into:
- ‚úÖ Email receiving (mailgun-inbound)
- ‚úÖ Inbox creation (create-inbox)
- ‚úÖ Bounce notifications
- ‚úÖ Security blocks

### **Step 3: Test the System**
```bash
# View current metrics
curl https://onetimeemail.vercel.app/api/metrics

# Run cleanup manually
curl -X POST https://onetimeemail.vercel.app/api/cleanup-expired

# View cleanup results
curl https://onetimeemail.vercel.app/api/cleanup-expired
```

## üîÑ **How to Use**

### **Manual Cleanup**
```bash
# Run cleanup process
curl -X POST https://onetimeemail.vercel.app/api/cleanup-expired
```

**Response:**
```json
{
  "success": true,
  "message": "Cleanup completed successfully",
  "results": {
    "expired_emails_deleted": 15,
    "expired_inboxes_cleaned": 8,
    "total_emails_after": 42,
    "total_inboxes_after": 12
  },
  "cleanup_summary": {
    "emails_deleted": 15,
    "inboxes_cleaned": 8,
    "space_saved": "15 emails removed",
    "current_active_emails": 42,
    "current_active_inboxes": 12
  }
}
```

### **View Metrics Dashboard**
```bash
# Get comprehensive metrics
curl https://onetimeemail.vercel.app/api/metrics
```

**Response:**
```json
{
  "success": true,
  "metrics": {
    "generation_statistics": {
      "total_emails_generated": 89,
      "total_inboxes_created": 89,
      "current_active_inboxes": 12,
      "total_inboxes_ever": 89
    },
    "email_statistics": {
      "total_emails_received": 127,
      "total_emails_sent": 23,
      "current_active_emails": 42
    },
    "expiry_statistics": {
      "total_inboxes_expired": 77,
      "total_emails_expired": 85,
      "total_expired_inboxes_cleaned": 77,
      "total_expired_emails_deleted": 85
    },
    "security_statistics": {
      "total_bounce_notifications": 23,
      "total_suspicious_emails_blocked": 5,
      "total_rate_limited_emails": 8
    }
  },
  "insights": {
    "bounce_rate": "15.3%",
    "security_block_rate": "8.7%",
    "active_inbox_percentage": "13.5%",
    "expiry_rate": "86.5%"
  }
}
```

## ‚è∞ **Automated Cleanup (Recommended)**

### **Option 1: Vercel Cron (Pro Plan)**
Create `vercel.json`:
```json
{
  "crons": [
    {
      "path": "/api/cleanup-expired",
      "schedule": "0 2 * * *"
    }
  ]
}
```

### **Option 2: External Cron Service**
Use services like:
- **Cron-job.org** (free)
- **EasyCron** (free tier)
- **UptimeRobot** (monitoring + cron)

**Setup:**
1. Create cron job
2. **URL:** `https://onetimeemail.vercel.app/api/cleanup-expired`
3. **Method:** POST
4. **Schedule:** Daily at 2 AM
5. **Frequency:** `0 2 * * *`

### **Option 3: GitHub Actions**
Create `.github/workflows/cleanup.yml`:
```yaml
name: Daily Cleanup
on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:      # Manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Run Cleanup
        run: |
          curl -X POST https://onetimeemail.vercel.app/api/cleanup-expired
```

## üìà **Monitoring & Insights**

### **Key Metrics to Watch:**
- **Bounce Rate:** Should be reasonable (< 20%)
- **Active Emails:** Monitor growth trend
- **Security Blocks:** Track malicious activity
- **Cleanup Efficiency:** Emails deleted vs. kept

### **Example Monitoring Queries:**
```sql
-- View all metrics
SELECT * FROM metrics ORDER BY updated_at DESC;

-- Get specific metric
SELECT metric_value FROM metrics WHERE metric_name = 'total_emails_received';

-- Calculate bounce rate
SELECT 
  (SELECT metric_value FROM metrics WHERE metric_name = 'total_bounce_notifications') * 100.0 / 
  (SELECT metric_value FROM metrics WHERE metric_name = 'total_emails_received') as bounce_rate_percent;
```

## üîß **Customization**

### **Adjust Cleanup Frequency**
Modify cleanup criteria in `cleanup-expired/route.ts`:
```typescript
// Change expiration check (currently: expired inboxes)
.lt('expires_at', new Date().toISOString())

// Keep emails for 24 hours after inbox expiry
const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000)
.lt('expires_at', dayAgo.toISOString())
```

### **Add Custom Metrics**
```typescript
// Track custom events
await trackMetric('custom_metric_name', 1)

// In any API endpoint
await supabase.rpc('increment_metric', {
  metric_name_param: 'custom_events',
  increment_by: 1
})
```

## üèÜ **Benefits**

### **Cost Savings:**
- ‚úÖ **Reduced storage costs** (delete old emails)
- ‚úÖ **Better performance** (smaller database)
- ‚úÖ **Optimized queries** (fewer records to scan)

### **Analytics:**
- ‚úÖ **Service insights** (usage patterns)
- ‚úÖ **Security monitoring** (attack detection)
- ‚úÖ **Performance tracking** (success rates)

### **Maintenance:**
- ‚úÖ **Automated cleanup** (set and forget)
- ‚úÖ **Health monitoring** (metrics dashboard)
- ‚úÖ **Proactive alerts** (monitor unusual activity)

## üö® **Important Notes**

### **Data Retention:**
- **Expired emails** are permanently deleted
- **Inactive inboxes** are marked inactive (not deleted)
- **Metrics** are kept forever (for analytics)

### **Safety:**
- **Only expired data** is cleaned up
- **Active inboxes** are never touched
- **Cleanup is reversible** (if needed, restore from backups)

### **Performance:**
- **Cleanup runs quickly** (< 30 seconds typically)
- **No impact** on active email processing
- **Database indexes** ensure fast operations

## üìã **Maintenance Checklist**

### **Weekly:**
- [ ] Check metrics dashboard
- [ ] Verify cleanup is running
- [ ] Monitor bounce rates

### **Monthly:**
- [ ] Review storage usage
- [ ] Analyze trends
- [ ] Optimize if needed

### **Quarterly:**
- [ ] Review retention policies
- [ ] Update cleanup frequency if needed
- [ ] Archive old metrics if desired

---

## üéØ **Quick Start Commands**

```bash
# 1. Create metrics table (run SQL from database/06_create_metrics_table.sql)

# 2. Test current metrics
curl https://onetimeemail.vercel.app/api/metrics

# 3. Run manual cleanup
curl -X POST https://onetimeemail.vercel.app/api/cleanup-expired

# 4. Set up automated cleanup (choose one method above)

# 5. Monitor regularly via metrics dashboard
```

**Your temporary email service now has professional-grade cleanup and analytics!** üöÄ 